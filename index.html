<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">

// I multiply the height to maintain the aspect ratio of the original centipede game
var windowScale = 1;
var windowWidth = 475*windowScale;
var windowHeight = 515*windowScale;
var spriteSize = 8;

var numLanes = 30;  // How many "lanes" do we have on our screen? The original centipede has 30
var clampSize = windowWidth/numLanes; // How wide and how tall is a "lane"?
var scale = clampSize/spriteSize;

var centerLaneX = (windowWidth/2 - (windowWidth/2)%clampSize)

var actualSpriteSize = spriteSize*scale;

var spawnZoneHeight = windowHeight - 60; // This prevents spawning mushrooms in the area where the player spawns

var game = new Phaser.Game(windowWidth, windowHeight, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

	game.load.image('player', 'assets/player.png');
	game.load.spritesheet('mushroom', 'assets/mushroom.png', spriteSize, spriteSize);
	game.load.image('centipedeHead', 'assets/centipedeHead.png');
	game.load.image('centipedeBody', 'assets/centipedeBody.png');
	game.load.image('bullet', 'assets/newBullet.png');
}

var player;
var numLives = 3;
var playerMoveSpeed = 275*windowScale;

var mushrooms;
var numMushrooms = 25;

var centipedes;
var numCentipedeSections = 15;
var centipedeMoveSpeed = 275*windowScale;

// Variables that hold events for arrow key presses and spacebar presses
var movement;
var fire;

// Variables that allow restriction of movement for the player.
var canMoveLeft = true;
var canMoveRight = true;
var canMoveUp = true;
var canMoveDown = true;

var bulletSpeed = 325;
var bulletTime = 0; // Keep 0, this tracks the time since we fired our last bullet.
var fireRate = 0;
var maxBullets = 1;
var bullet;

var score = 0;
var scoreText;

function create() 
{
    game.physics.startSystem(Phaser.Physics.ARCADE);

	// Mushrooms
	
    mushrooms = game.add.group();
	
	// Enables physics for everything in our mushrooms group
    mushrooms.enableBody = true; 
	mushrooms.physicBodyType = Phaser.Physics.ARCADE;
	
	// Make and place numMushrooms mushrooms in our safe zone.  Safe zone being the area below the score at the top and above where our player can move.
	for (var i = 0; i < numMushrooms; i++)
	{
		var randX = game.world.randomX;
		var randY = Math.random() * spawnZoneHeight;
		randX = randX - (randX%clampSize);
		randY = randY - (randY%clampSize);
		if (randY < clampSize*2) randY = clampSize*2; // This prevents mushrooms from being spawned in the top 2 rows

	    var mushroom = mushrooms.create(randX, randY, 'mushroom')// game.rnd.integerInRange(0, 36)); This extra parameter allows us to randomize which frame to spawn our mushroom on
		mushroom.body.immovable = true;
		
		mushroom.scale.setTo(scale, scale);
	}
	
	// Bullet
	bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;
	
    for (var i = 0; i < maxBullets; i++) // Right now, we're only allowing 1 bullet on the screen at a time, as is the case in Centipede.
    {
        var b = game.add.sprite(0, 0, 'bullet');
        b.name = 'bullet' + i;
        b.exists = false;
        b.visible = false;
        b.checkWorldBounds = true;
        b.events.onOutOfBounds.add(resetBullet, this);
		
		b.scale.setTo(scale, scale);
		
		bullets.add(b);
    }
	
	// Centipedes
	centipedes = game.add.group();
	centipedes.enableBody = true; 
	centipedes.physicBodyType = Phaser.Physics.ARCADE;
	
	// Just the head of the centipede
	var centipedeSection = game.add.sprite(centerLaneX, actualSpriteSize, 'centipedeHead');
	centipedeSection.scale.setTo(scale, scale);
	centipedes.add(centipedeSection);
	
	// The body of the centipede
	for (var i = 1; i < numCentipedeSections; i++)
	{
		var centipedeSection = game.add.sprite(centerLaneX, actualSpriteSize+(i*actualSpriteSize), 'centipedeBody');
		centipedes.add(centipedeSection);
		centipedeSection.scale.setTo(scale, scale);
	}
	
    // The player and its settings
    player = game.add.sprite(centerLaneX, game.world.height - 25, 'player');
	player.scale.setTo(scale, scale);
	
    //  We need to enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties. Give the little guy a slight bounce.
    //player.body.gravity.y = 0;
    player.body.collideWorldBounds = true;
	
	// Not sure if this is doing what I intended; It's not.  TO-DO: Set top bound of player
	//player.body.world.top = game.world.height - 60;

    //  The score
    scoreText = game.add.text(windowWidth*0.2, 4, '', { fontSize: '24px', fill: '#d00000', align: 'right' });
	scoreText.text = "00";
    //  Our controls.
    movement = game.input.keyboard.createCursorKeys();
	fire = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
}

function update() 
{
	
	// Detect collisions
    game.physics.arcade.overlap(player, centipedes, killPlayer, null, this);
	game.physics.arcade.overlap(bullets, centipedes, killCentipede, null, this);
    game.physics.arcade.overlap(bullets, mushrooms, damageMushroom, null, this);
    game.physics.arcade.overlap(centipedes, mushrooms, turnCentipedeSection, null, this);
    game.physics.arcade.collide(player, mushrooms, stopMovement, null, this);
	
	if (player.body.touching.none) resetMovement();
	
	UpdateMovement();
	UpdateCentipedes();
	
	if (fire.isDown) fireBullet();
}

function resetMovement()
{
	canMoveDown = true;
	canMoveLeft = true;
	canMoveUp = true;
	canMoveRight = true;
}

// This whole mentod isn't needed :(
function stopMovement(player, mushroom)
{
	// Per mushroom, we can only have one edge colliding with our player.  If we are colliding with more than one mushroom this method will be called more than once.
	
	var collidedHorizontally = false;
	var collidedVertically = false;
	
	// Collision Right
	if (player.body.touching.right)
	{
		canMoveLeft = true;
		canMoveRight = false;
		
		collidedHorizontally = true;
	}
	// Collision Left
	else if (player.body.touching.left)
	{
		canMoveRight = true;
		canMoveLeft = false;
		
		collidedHorizontally = true;
	}
	
	// Collision on Bottom
	if (player.body.touching.down)
	{
		canMoveUp = true;
		canMoveDown = false;
		
		collidedVertically = true;
	}
	// Collision on Top
	else if (player.body.touching.up)
	{
		canMoveDown = true;
		canMoveUp = false;

		collidedVertically = true;
	}
	
	if (collidedHorizontally || collidedVertically)
	{
		return true;
	}
	
	return false;
}
function UpdateMovement()
{
    //  Reset the players velocity (movement)
    player.body.velocity.x = 0; // We only have velocity if we are still pressing one of the keys
	player.body.velocity.y = 0;
	
    if (movement.left.isDown && canMoveLeft)
    {
        player.body.velocity.x = -playerMoveSpeed;
    }
    else if (movement.right.isDown && canMoveRight)
    {
        player.body.velocity.x = playerMoveSpeed;
    }
	
	if (movement.up.isDown && canMoveUp)
	{
		player.body.velocity.y = -playerMoveSpeed;
	}
	else if (movement.down.isDown && canMoveDown)
	{
		player.body.velocity.y = playerMoveSpeed;
	}
}

function UpdateCentipedes()
{
	
}

// Called when the centipede collides with the player
function killPlayer (player, centipedeSection) 
{   
    // Removes the player from the screen
    player.kill();
	numLives--;

	if (numLives == 0)
	{
		// GameOver
		scoreText.text = 'Game Over';
	}
	else 
	{
		// Respawn the player.  This will change later, adding the delay present in centip
        player.reset(centerLaneX, game.world.height - 25);
	}
}

// Called when a bullet collides with a part of the centipede
function killCentipede(bullet, centipedeSection)
{
	bullet.kill();
	centipedeSection.kill();
	
	score += 10;
	scoreText.text = score;
	
	// TO DO: Split Centipede
}

// Called when a centipede collides with a mushroom.  We need to turn the one section.
function turnCentipedeSection(centipedeSection, mushroom)
{
	// TO-DO
}

// Called when a bullet collides with a mushroom
function damageMushroom(bullet, mushroom)
{
	bullet.kill();
	var temp = mushroom.frame + 1;
	mushroom.frame = temp;
	
	if (temp > 3)
	{
		score += 1;
		scoreText.text = score;
		mushroom.kill();
	}
}

// This finds one of our currently "retired" bullets from our group of bullets and sends it up the screen
function fireBullet () 
{
    if (game.time.now > bulletTime)
    {
        bullet = bullets.getFirstExists(false);

        if (bullet)
        {
            bullet.reset(player.x+(actualSpriteSize/2), player.y - 8);
            bullet.body.velocity.y = -bulletSpeed;
            bulletTime = game.time.now + fireRate;
        }
    }

}

//  Called if the bullet goes out of the screen
function resetBullet (bullet) 
{
    bullet.kill();
}
</script>

</body>
</html>