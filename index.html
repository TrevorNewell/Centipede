<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<div style="text-align:center">
<script type="text/javascript">

var windowWidth = 450;
var windowHeight = 525;

var spawnZoneHeight = windowHeight - 60; // This prevents spawning mushrooms in the area where the player spawns

var game = new Phaser.Game(windowWidth, windowHeight, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

	game.load.image('player', 'assets/player.png');
	game.load.spritesheet('mushroom', 'assets/mushroom.png', 8, 8);
	game.load.image('centipedeHead', 'assets/centipedeHead.png');
	game.load.image('centipedeBody', 'assets/centipedeBody.png');
	game.load.image('bullet', 'assets/bullet.png');
}

var player;
var numLives = 3;

var mushrooms;
var numMushrooms = 25;

var centipedes;
var numCentipedeSections = 15;

var movement;
var fire;
var bulletTime = 0; // Keep 0, this tracks the time since we fired our last bullet.
var fireRate = 150;
var maxBullets = 1;
var bullet;

var score = 0;
var scoreText;

function create() 
{
    game.physics.startSystem(Phaser.Physics.ARCADE);

	// Mushrooms
	
    mushrooms = game.add.group();
	
	// Enables physics for everything in our mushrooms group
    mushrooms.enableBody = true; 
	mushrooms.physicBodyType = Phaser.Physics.ARCADE;
	
	// Make and place numMushrooms mushrooms in our safe zone.  Safe zone being the area below the score at the top and above where our player can move.
	for (var i = 0; i < numMushrooms; i++)
	{
	    var mushroom = mushrooms.create(game.world.randomX, Math.random() * (spawnZoneHeight), 'mushroom')// game.rnd.integerInRange(0, 36)); This extra parameter allows us to randomize which frame to spawn our mushroom on
		mushroom.body.immovable = true;
	}
	
	// Bullet
	bullets = game.add.group();
    bullets.enableBody = true;
    bullets.physicsBodyType = Phaser.Physics.ARCADE;
	
    for (var i = 0; i < maxBullets; i++) // Right now, we're only allowing 1 bullet on the screen at a time, as is the case in Centipede.
    {
        var b = bullets.create(0, 0, 'bullet');
        b.name = 'bullet' + i;
        b.exists = false;
        b.visible = false;
        b.checkWorldBounds = true;
        b.events.onOutOfBounds.add(resetBullet, this);
    }
	
	// Centipedes
	centipedes = game.add.group();
	
	var centipedeSection = centipedes.create(0, 8, 'centipedeHead');
	
	for (var i = 1; i<10; i++)
	{
		var centipedeSection = centipedes.create(i*8, 8, 'centipedeBody');
	}
	
    // The player and its settings
    player = game.add.sprite(game.world.width/2, game.world.height - 15, 'player');

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties. Give the little guy a slight bounce.
    //player.body.gravity.y = 0;
    player.body.collideWorldBounds = true;
	
	// Not sure if this is doing what I intended; It's not.  TO-DO: Set top bound of player
	//player.body.world.top = game.world.height - 60;

    //  The score
    scoreText = game.add.text(16, 16, '', { fontSize: '32px', fill: '#000' });

    //  Our controls.
    movement = game.input.keyboard.createCursorKeys();
	fire = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
}

function update() 
{
    game.physics.arcade.overlap(player, centipedes, killPlayer, null, this);
    game.physics.arcade.overlap(bullet, mushrooms, damageMushroom, null, this);
    //game.physics.arcade.collide(centipedes, mushrooms, turnCentipedeSection, null, this);

    //  Reset the players velocity (movement)
    player.body.velocity.x = 0; // We only have velocity if we are still pressing one of the keys
	player.body.velocity.y = 0;
	
    if (movement.left.isDown)
    {
        player.body.velocity.x = -150;
    }
    else if (movement.right.isDown)
    {
        player.body.velocity.x = 150;
    }
	
	if (movement.up.isDown)
	{
		player.body.velocity.y = -150;
	}
	else if (movement.down.isDown)
	{
		player.body.velocity.y = 150;
	}
	
	if (fire.isDown)
    {
        fireBullet();
    }
}

// Called when the centipede collides with the player
function killPlayer (player, centipedeSection) 
{   
    // Removes the player from the screen
    player.kill();
	numLives--;

	if (numLives == 0)
	{
		// GameOver
		scoreText.text = 'Game Over';
	}
	else 
	{
		// Respawn the player.  This will change later, adding the delay present in centip
        player.reset(8, game.world.height - 150);
	}
}

// Called when a bullet collides with a part of the centipede
function killCentipede(bullet, centipedeSection)
{
	bullet.kill();
	centipede.kill();
	
	score += 10;
	scoreText.text = 'Score: ' + score;
	
	// TO DO: Split Centipede
}

// Called when a centipede collides with a mushroom.  We need to turn the one section.
function turnCentipedeSection(centipedeSection, mushroom)
{
	// TO-DO
}

// Called when a bullet collides with a mushroom
function damageMushroom(bullet, mushroom)
{
	bullet.kill();
	mushroom.kill();
	mushroom.frame += 1;
	
	if (mushroom.frame > 4)
	{
		mushroom.kill();
		mushroom.frame = 0;
	}
}

// This finds one of our currently "retired" bullets from our group of bullets and sends it up the screen
function fireBullet () 
{
    if (game.time.now > bulletTime)
    {
        bullet = bullets.getFirstExists(false);

        if (bullet)
        {
            bullet.reset(player.x, player.y - 8);
            bullet.body.velocity.y = -300;
            bulletTime = game.time.now + fireRate;
        }
    }

}

//  Called if the bullet goes out of the screen
function resetBullet (bullet) 
{
    bullet.kill();
}


</script>
</div>

</body>
</html>